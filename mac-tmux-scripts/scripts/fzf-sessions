#!/usr/bin/env bash

# Function to get icon for session name
get_icon() {
	local session="$1"
	case "$session" in
		dotfiles) echo "âš™ï¸  " ;;
		local_mymoc) echo "ğŸ–¥ï¸  " ;;
		mymoc) echo "ğŸ’ " ;;
		mymoc_worktree) echo "ğŸ’ " ;;
		frontend-dev|front_end) echo "ğŸ…°ï¸  " ;;
		weechat) echo "ğŸ’¬ " ;;
		specs) echo "ğŸ“‹ " ;;
		obsidian) echo "ğŸ“ " ;;
		music) echo "ğŸµ " ;;
		mobile) echo "ğŸ“± " ;;
		gemini) echo "ğŸ¤– " ;;
		hass-pi) echo "ğŸ  " ;;
		*) echo "   " ;;
	esac
}

MUX_SESSIONS=$(tmuxinator list | tail -n +2 | tr -s '[:space:]' '\n')
TMUX_EXISTING=$(tmux list-sessions -F '#S' 2>/dev/null)
SESSIONS=$( (
	echo "$TMUX_EXISTING"
	echo "$MUX_SESSIONS"
) | sort -u)

# Add icons to sessions for display
SESSIONS_WITH_ICONS=""
while IFS= read -r session; do
	[ -z "$session" ] && continue
	icon=$(get_icon "$session")

	# Check if session is running
	if echo "$TMUX_EXISTING" | grep -q "^$session$"; then
		indicator="â— "  # Running indicator (green dot)
	else
		indicator="â—‹ "  # Not running indicator (empty circle)
	fi

	SESSIONS_WITH_ICONS+="${indicator}${icon}${session}"$'\n'
done <<< "$SESSIONS"

# Use fzf to select, then strip the icon to get the actual session name
SELECTED=$(echo "$SESSIONS_WITH_ICONS" | fzf \
	--prompt="Select session: " \
	--ansi \
	--header="Enter: switch | Alt-Backspace: kill session" \
	--bind "alt-bspace:execute-silent(
		session=\$(echo {} | sed -E 's/^[[:space:]]*[^[:space:]]+[[:space:]]*[^[:space:]]+[[:space:]]*//');
		if tmux list-sessions -F '#S' 2>/dev/null | grep -q \"^\$session\$\"; then
			tmux kill-session -t \"\$session\";
		fi
	)+reload(
		MUX_SESSIONS=\$(tmuxinator list | tail -n +2 | tr -s '[:space:]' '\\\n');
		TMUX_EXISTING=\$(tmux list-sessions -F '#S' 2>/dev/null);
		SESSIONS=\$(echo \"\$TMUX_EXISTING\"; echo \"\$MUX_SESSIONS\" | sort -u);
		while IFS= read -r session; do
			[ -z \"\$session\" ] && continue;
			case \"\$session\" in
				dotfiles) icon=\"âš™ï¸  \";;
				local_mymoc) icon=\"ğŸ–¥ï¸  \";;
				mymoc) icon=\"ğŸ’ \";;
				mymoc_worktree) icon=\"ğŸ’ \";;
				frontend-dev|front_end) icon=\"ğŸ…°ï¸  \";;
				weechat) icon=\"ğŸ’¬ \";;
				specs) icon=\"ğŸ“‹ \";;
				obsidian) icon=\"ğŸ“ \";;
				music) icon=\"ğŸµ \";;
				mobile) icon=\"ğŸ“± \";;
				gemini) icon=\"ğŸ¤– \";;
				hass-pi) icon=\"ğŸ  \";;
				*) icon=\"   \";;
			esac;
			if echo \"\$TMUX_EXISTING\" | grep -q \"^\$session\$\"; then
				indicator=\"â— \";
			else
				indicator=\"â—‹ \";
			fi;
			echo \"\${indicator}\${icon}\${session}\";
		done <<< \"\$SESSIONS\"
	)")
[ -z "$SELECTED" ] && exit 0

# Strip indicator and icon to get session name
SESSION=$(echo "$SELECTED" | sed -E 's/^[[:space:]]*[^[:space:]]+[[:space:]]*[^[:space:]]+[[:space:]]*//')

if echo "$TMUX_EXISTING" | grep -q "^$SESSION$"; then
	# Session already exists, just switch to it
	tmux switch-client -t "$SESSION"
elif echo "$MUX_SESSIONS" | grep -q "^$SESSION$"; then
	# It's a tmuxinator session, but not running. Start it without attaching, then switch.
	# If your tmuxinator version doesn't support --no-attach, remove it and handle differently.
	tmuxinator start "$SESSION"
	tmux switch-client -t "$SESSION"
else
	# Neither existing nor a known tmuxinator session
	tmux new -d -s "$SESSION"
	tmux switch-client -t "$SESSION"
fi
