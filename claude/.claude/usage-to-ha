#!/bin/bash
# Show usage and send to Home Assistant
# Usage: usage-to-ha

HASS_HOST="http://192.168.1.8:8123"
HASS_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiI2MjAwNTQwNDUwMDE0NDM2Yjk5MjJhMjk5MzhhYzMwNiIsImlhdCI6MTc1ODc5NjU1NiwiZXhwIjoyMDc0MTU2NTU2fQ.fU5j0lYPLsiMYejB0EHEFiphUd-9lwqa8PaISN4vcGY"

# Show usage and capture in background
echo "ðŸ“Š Checking Claude usage..."
echo ""

# Run usage command and let user see it
claude usage

# After they exit, prompt for update
echo ""
read -p "Update Home Assistant? (y/N): " -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
    read -p "Session %: " SESSION
    read -p "Week (All) %: " WEEK_ALL
    read -p "Week (Opus) %: " WEEK_OPUS

    # Update HA
    for entity in "claude_usage_session:$SESSION:Current Session" "claude_usage_week_all:$WEEK_ALL:Week (All Models)" "claude_usage_week_opus:$WEEK_OPUS:Week (Opus)"; do
        IFS=':' read -r id val name <<< "$entity"
        curl -s -X POST -H "Authorization: Bearer $HASS_TOKEN" -H "Content-Type: application/json" \
            -d "{\"state\": \"$val\", \"attributes\": {\"unit_of_measurement\": \"%\", \"friendly_name\": \"Claude Usage ($name)\", \"icon\": \"mdi:brain\"}}" \
            "$HASS_HOST/api/states/sensor.$id" > /dev/null
    done

    echo "âœ… Updated Home Assistant"
else
    echo "Skipped update"
fi
